### Ethers 学习教程（v6 简明版）

#### 概览

Ethers.js 是一个轻量、模块化的以太坊交互库。常用核心概念：`Provider`（读链），`Signer`（签名/发交易），`Contract`（合约封装），`utils`（单位与工具）。

#### Provider（读链网关）

Provider 负责与节点通信，提供只读能力与事件订阅，本身不具备签名与发交易能力。

- 常见类型：
  - `JsonRpcProvider`：通过 HTTP RPC 连接本地/远程节点
  - `WebSocketProvider`：更适合事件订阅
  - `BrowserProvider`：浏览器环境中通过钱包（如 MetaMask）暴露的 EIP-1193 Provider
- 典型能力：
  - 读取账户余额、区块、交易、日志
  - 调用合约 `view/pure` 方法
  - 监听新区块与合约事件

示例：

```ts
import { JsonRpcProvider, BrowserProvider } from 'ethers';

const provider = new JsonRpcProvider('http://127.0.0.1:8545');
const balanceWei = await provider.getBalance('0x...address');

// 浏览器钱包
const browserProvider = new BrowserProvider(window.ethereum);
const network = await browserProvider.getNetwork();
```

#### Signer 与 Wallet（签名/发交易）

Signer 表示“能签名交易的实体”。来源通常有两种：

- 浏览器钱包：`const signer = await browserProvider.getSigner()`
- 私钥本地钱包：`new Wallet(privateKey, provider)`

示例：

```ts
import { BrowserProvider, Wallet } from 'ethers';

// 1) 浏览器钱包
const browserProvider = new BrowserProvider(window.ethereum);
const signer = await browserProvider.getSigner();

// 2) 私钥钱包（仅示例，生产环境不要硬编码私钥）
const wallet = new Wallet('0xabc...', provider);
```

#### Contract（合约交互）

`Contract` 封装了 ABI 与地址。

- 只读：使用 `provider` 实例化
- 可写：使用 `signer` 或 `contract.connect(signer)` 发交易

示例（ERC20）：

```ts
import { Contract, parseUnits } from 'ethers';

const erc20 = new Contract(tokenAddress, erc20Abi, provider);
const decimals = await erc20.decimals();
const name = await erc20.name();

// 写操作
const erc20WithSigner = erc20.connect(signer);
const tx = await erc20WithSigner.transfer('0xRecipient', parseUnits('1.5', decimals));
const receipt = await tx.wait(); // 等待上链
```

#### 单位与格式化（常用 utils）

- `parseEther("1.23")` / `formatEther(value)`：ETH 与 wei 互转
- `parseUnits("123", 6)` / `formatUnits(value, 6)`：任意精度单位互转（如 USDC 6 位）
- 地址工具：`getAddress`（校验并规范化），`isAddress`

示例：

```ts
import { parseEther, formatEther, parseUnits, formatUnits, getAddress, isAddress } from 'ethers';

const value = parseEther('0.05');
const shown = formatEther(value);
const usdc = parseUnits('12.34', 6);
const back = formatUnits(usdc, 6);
const checksum = getAddress('0xabc...');
const valid = isAddress('0xabc...');
```

#### 事件与日志（监听/取消）

```ts
// 监听新区块
const unsub = provider.on('block', (blockNumber) => {
  console.log('new block', blockNumber);
});

// 合约事件
const ex = new Contract(exchangeAddress, exchangeAbi, provider);
const off = ex.on('Swap', (sender, amountIn, amountOut, event) => {
  console.log(sender, amountIn, amountOut);
});

// 取消监听
unsub?.();
off?.();
```

#### 交易生命周期与费用

- `estimateGas` 预估 gas，用于提前发现失败风险
- `gasPrice` 或 EIP-1559：`maxFeePerGas`/`maxPriorityFeePerGas`
- 发起后获取 `tx`，常用 `await tx.wait()` 等待确认

```ts
const gas = await erc20WithSigner.transfer('0x...', amount).then((tx) => tx.wait());
```

#### 错误处理与常见坑

- 用户拒绝签名（EIP-1193 `4001`）需要优雅提示
- 余额不足/nonce 冲突/链不匹配：捕获错误并给出引导
- BigInt/BigNumber：统一走 `parseUnits/formatUnits`，避免精度丢失
- 一定要区分 `provider`（读） 与 `signer`（写）；写操作务必 `.connect(signer)`
- 别忘记 `await tx.wait()`，否则 UI 可能在确认前就“完成”

#### 网络与多链

- `await provider.getNetwork()` 获取 `chainId`
- 与前端钱包交互时，确保链一致；必要时请求切链或添加网络

#### 速查表（Cheat Sheet）

- 读余额：`provider.getBalance(addr)`
- 获取 signer：`await new BrowserProvider(window.ethereum).getSigner()`
- 合约读：`new Contract(addr, abi, provider).method()`
- 合约写：`new Contract(addr, abi, signer).method(); await tx.wait()`
- 单位换算：`parseUnits/formatUnits`、`parseEther/formatEther`
- 事件监听：`provider.on("block", cb)`、`contract.on("Event", cb)`

以上覆盖了 dApp 开发最常用的 80% 场景，可在此基础上逐步扩展（签名消息、离线签名、ENS、账户抽象等）。
